// Personal Ops - IDL DSL v1.2.3
// Governanca de operacoes pessoais de arquivos com approvals para acoes destrutivas.
// Jobs-First: todas operacoes via job.request/job.get/job.enqueue.

system PersonalOps {
  name: "Personal Ops"
  description: "Governanca de operacoes pessoais de arquivos via Jobs First-Class. Acoes destrutivas requerem approval."
  version: 1.0.0
  domain: "personal_ops"
  owner: "Libervia"
  contact: "ops@libervia.xyz"
  tenancy: multi
}

// =============================================================================
// ACTORS - Roles reais usados pelo Console API
// =============================================================================

actors {
  // Role "owner" from Console API tokens
  human inst_owner {
    name: "Institution Owner"
    description: "Proprietario da instituicao. Criado no onboarding. Pode operar arquivos e decidir approvals."
    authentication: oauth2
    permissions: [
      files.list,
      files.scan,
      files.suggest,
      files.rename,
      files.move,
      files.delete,
      jobs.get,
      approval.decide
    ]
  }

  // Role "executive_admin" from Console API tokens
  human exec_admin {
    name: "Executive Admin"
    description: "Administrador executivo. Pode decidir approvals para acoes destrutivas."
    authentication: oauth2
    permissions: [
      files.list,
      files.scan,
      files.suggest,
      jobs.get,
      approval.decide
    ]
  }

  // Role "agent" from Console API tokens
  system runtime_agent {
    name: "Agent Runtime"
    description: "Agente LLM governado que executa operacoes aprovadas via Runtime."
    authentication: token
    permissions: [
      files.list,
      files.scan,
      files.suggest,
      files.rename,
      files.move,
      files.delete,
      jobs.get,
      jobs.enqueue,
      runtime.bundle.load,
      runtime.proof.snapshot,
      runtime.safe_mode.enter
    ]
  }
}

// =============================================================================
// POLICY CONTEXT
// =============================================================================

policy_context {
  field jurisdiction: string required
  field risk_level: string default("low")
  field file_sensitivity: string default("normal")
}

// =============================================================================
// APPROVAL RULES - Acoes destrutivas requerem approval
// =============================================================================

approval_rules {
  // Delete de arquivos requer approval de inst_owner ou exec_admin
  rule job_files_delete_requires_approval {
    trigger: api "POST /personal/jobs/files/delete"
    approver_roles: [inst_owner, exec_admin]
    quorum: 1
  }

  // Rename de arquivos requer approval de inst_owner ou exec_admin
  rule job_files_rename_requires_approval {
    trigger: api "POST /personal/jobs/files/rename"
    approver_roles: [inst_owner, exec_admin]
    quorum: 1
  }

  // Move de arquivos requer approval de inst_owner ou exec_admin
  rule job_files_move_requires_approval {
    trigger: api "POST /personal/jobs/files/move"
    approver_roles: [inst_owner, exec_admin]
    quorum: 1
  }
}

// =============================================================================
// OPERATIONS - Jobs First-Class Only
// =============================================================================

operations {
  api {
    // =========================================================================
    // SAFE JOBS (no approval required)
    // =========================================================================

    endpoint job_files_list {
      method: POST
      path: "/personal/jobs/files/list"
      request: any
      response: any
      permission: files.list
      scope: tenant
      idempotency: none
      errors: [400, 401, 403]
      bind: { kind: job.request, job_type: "files.list" }
    }

    endpoint job_files_scan {
      method: POST
      path: "/personal/jobs/files/scan"
      request: any
      response: any
      permission: files.scan
      scope: tenant
      idempotency: none
      errors: [400, 401, 403]
      bind: { kind: job.request, job_type: "files.scan" }
    }

    endpoint job_files_suggest {
      method: POST
      path: "/personal/jobs/files/suggest"
      request: any
      response: any
      permission: files.suggest
      scope: tenant
      idempotency: none
      errors: [400, 401, 403]
      bind: { kind: job.request, job_type: "files.suggest" }
    }

    // =========================================================================
    // DESTRUCTIVE JOBS (approval required via approvals.json rules)
    // The job_dispatcher checks approvals.json for rules matching these job_types.
    // =========================================================================

    endpoint job_files_rename {
      method: POST
      path: "/personal/jobs/files/rename"
      request: any
      response: any
      permission: files.rename
      scope: tenant
      idempotency: none
      errors: [400, 401, 403]
      bind: { kind: job.request, job_type: "files.rename" }
    }

    endpoint job_files_move {
      method: POST
      path: "/personal/jobs/files/move"
      request: any
      response: any
      permission: files.move
      scope: tenant
      idempotency: none
      errors: [400, 401, 403]
      bind: { kind: job.request, job_type: "files.move" }
    }

    endpoint job_files_delete {
      method: POST
      path: "/personal/jobs/files/delete"
      request: any
      response: any
      permission: files.delete
      scope: tenant
      idempotency: none
      errors: [400, 401, 403]
      bind: { kind: job.request, job_type: "files.delete" }
    }

    // =========================================================================
    // JOB LIFECYCLE
    // =========================================================================

    endpoint job_get {
      method: GET
      path: "/personal/jobs/{job_id}"
      request: void
      response: any
      permission: jobs.get
      scope: tenant
      idempotency: none
      errors: [400, 401, 403, 404]
      bind: { kind: job.get }
    }

    endpoint job_enqueue {
      method: POST
      path: "/personal/jobs/{job_id}/enqueue"
      request: void
      response: any
      permission: jobs.enqueue
      scope: tenant
      idempotency: required
      errors: [400, 401, 403, 404, 409]
      bind: { kind: job.enqueue }
    }

    // =========================================================================
    // APPROVAL DECISION
    // =========================================================================

    endpoint approval_decide {
      method: POST
      path: "/approvals/{approval_id}/decide"
      request: any
      response: any
      permission: approval.decide
      scope: tenant
      idempotency: required
      errors: [400, 401, 403, 404, 409]
      bind: { kind: approval }
    }
  }
}
