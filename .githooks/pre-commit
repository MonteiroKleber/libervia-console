#!/bin/bash
# ==============================================================================
# pre-commit hook for libervia-console
#
# Blocks commits when:
# 1. Changes to idl/personal_ops/*.json or openapi.yaml WITHOUT changes to source.idl
# 2. Any .bak* files exist in idl/personal_ops/
#
# Enable: git config core.hooksPath .githooks
# ==============================================================================
set -euo pipefail

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

error() { echo -e "${RED}[pre-commit]${NC} $1" >&2; }
warn() { echo -e "${YELLOW}[pre-commit]${NC} $1"; }

IDL_DIR="idl/personal_ops"
SOURCE_IDL="$IDL_DIR/v1.0.0/source.idl"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

# ==============================================================================
# Check 1: No .bak files in staging or working tree
# ==============================================================================
BAK_STAGED=$(echo "$STAGED_FILES" | grep -E "idl/personal_ops/.*\.bak" || true)
BAK_EXISTS=$(find "$IDL_DIR" -name "*.bak*" 2>/dev/null || true)

if [ -n "$BAK_STAGED" ]; then
    error "BLOCKED: Cannot commit .bak files"
    error "Remove these files from staging:"
    echo "$BAK_STAGED" | while read -r f; do echo "  - $f"; done
    exit 1
fi

if [ -n "$BAK_EXISTS" ]; then
    error "BLOCKED: .bak files exist in $IDL_DIR"
    error "Remove before committing:"
    echo "$BAK_EXISTS" | while read -r f; do echo "  - $f"; done
    error ""
    error "Run: git rm $IDL_DIR/*.bak*"
    exit 1
fi

# ==============================================================================
# Check 2: Artifact changes require source.idl change
# ==============================================================================
# Artifacts that must only be generated, never edited manually
ARTIFACTS=(
    "$IDL_DIR/operations.json"
    "$IDL_DIR/rbac.json"
    "$IDL_DIR/mandates.json"
    "$IDL_DIR/approvals.json"
    "$IDL_DIR/autonomy.json"
    "$IDL_DIR/workflows.json"
    "$IDL_DIR/sod.json"
    "$IDL_DIR/invariants.json"
    "$IDL_DIR/policies.json"
    "$IDL_DIR/contract_ledger.json"
    "$IDL_DIR/openapi.yaml"
    "$IDL_DIR/bundle.manifest.json"
)

# Check if any artifacts are staged
ARTIFACT_CHANGED=0
CHANGED_ARTIFACTS=()

for artifact in "${ARTIFACTS[@]}"; do
    if echo "$STAGED_FILES" | grep -q "^${artifact}$"; then
        ARTIFACT_CHANGED=1
        CHANGED_ARTIFACTS+=("$artifact")
    fi
done

# Check if source.idl is also staged
SOURCE_CHANGED=0
if echo "$STAGED_FILES" | grep -q "^${SOURCE_IDL}$"; then
    SOURCE_CHANGED=1
fi

# If artifacts changed but source.idl didn't, block commit
if [ "$ARTIFACT_CHANGED" -eq 1 ] && [ "$SOURCE_CHANGED" -eq 0 ]; then
    error "BLOCKED: Artifact changes without source.idl change"
    error ""
    error "You are trying to commit changes to generated artifacts:"
    for f in "${CHANGED_ARTIFACTS[@]}"; do
        echo "  - $f"
    done
    error ""
    error "But source.idl was NOT modified."
    error ""
    error "Rule: Artifacts must only be generated from source.idl"
    error "      Never edit artifacts manually!"
    error ""
    error "To fix:"
    error "  1. Edit $SOURCE_IDL with your changes"
    error "  2. Run: ./scripts/idl_build_personal_ops.sh"
    error "  3. Stage both source.idl and generated artifacts"
    error "  4. Commit again"
    error ""
    error "Or to bypass (NOT RECOMMENDED):"
    error "  git commit --no-verify"
    exit 1
fi

# All checks passed
exit 0
